<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Page Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB"
          crossorigin="anonymous">
</head>

<body>
<div id="app">
<!--    login form-->
    <section v-if="!isMessage" class="bg-gray-50 min-h-screen flex items-center justify-center">
        <!-- login container -->
        <div class="bg-gray-100 flex rounded-2xl shadow-lg max-w-3xl p-5 items-center">
            <!-- form -->
            <div class="px-8 md:px-16">
                <h2 class="font-bold text-2xl text-[#002D74]">Set Your Name</h2>
                <form @submit.prevent="login" action="" class="flex flex-col gap-4">
                    <input v-model="name" class="p-2 mt-8 rounded-xl border" type="text" name="name" placeholder="name">
                    <button class="bg-[#002D74] rounded-xl text-white py-2 hover:scale-105 duration-300">Login</button>
                </form>
                <small v-if="warning">exceeded users</small>
            </div>

        </div>
    </section>
<!--    random-->
<!--    profile form-->
    <div class="modal-vue">
        <!-- overlay -->
        <div class="overlay" v-if="showModal">
            <div class="w-full h-full bg-white text-black">
                <div v-if="profile" class="font-sans leading-tight min-h-screen bg-grey-lighter p-8">
                    <div class="max-w-sm mx-auto bg-white rounded-lg overflow-hidden shadow-lg">
                        <div class="bg-cover h-40" style="background-image: url('https://images.unsplash.com/photo-1522093537031-3ee69e6b1746?ixlib=rb-0.3.5&ixid=eyJhcHBfaWQiOjEyMDd9&s=a634781c01d2dd529412c2d1e2224ec0&auto=format&fit=crop&w=2098&q=80');"></div>
                        <div class="border-b px-4 pb-6">
                            <div class="text-center sm:text-left sm:flex mb-4">
                                <img :src="profileImage" class="h-32 w-32 rounded-full border-4 border-white -mt-16 mr-4"  alt="image">
                                <div class="py-2">
                                    <h3 class="font-bold text-2xl mb-1">{{name}}</h3>
                                    <div class="inline-flex text-grey-dark sm:flex items-center">
                                        <svg class="h-5 w-5 text-grey mr-1" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path class="heroicon-ui" d="M5.64 16.36a9 9 0 1 1 12.72 0l-5.65 5.66a1 1 0 0 1-1.42 0l-5.65-5.66zm11.31-1.41a7 7 0 1 0-9.9 0L12 19.9l4.95-4.95zM12 14a4 4 0 1 1 0-8 4 4 0 0 1 0 8zm0-2a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></svg>
                                        Dhaka, BD
                                    </div>
                                </div>
                            </div>
                            <div class="flex">
                                <button @click="chatSwitch" class="flex-1 rounded-full border-2 border-grey font-semibold text-black px-4 py-2">Message</button>
                            </div>
                        </div>
                        <div class="px-4 py-4">
                            <div class="flex items-center text-grey-darker mb-4">
                                <svg class="h-6 w-6 text-grey mr-1" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path class="heroicon-ui" d="M12 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0-2a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm9 11a1 1 0 0 1-2 0v-2a3 3 0 0 0-3-3H8a3 3 0 0 0-3 3v2a1 1 0 0 1-2 0v-2a5 5 0 0 1 5-5h8a5 5 0 0 1 5 5v2z"/></svg>
                                <span><strong class="text-black">12</strong> Followers you know</span>
                            </div>
                            <div class="flex">
                                <div class="flex flex-row-reverse justify-end mr-2">
                                    <img class="border-2 border-white rounded-full h-10 w-10" src="https://randomuser.me/api/portraits/men/32.jpg" alt="">
                                    <img class="border-2 border-white rounded-full h-10 w-10 -mr-2" src="https://randomuser.me/api/portraits/women/31.jpg" alt="">
                                    <img class="border-2 border-white rounded-full h-10 w-10 -mr-2" src="https://randomuser.me/api/portraits/men/33.jpg" alt="">
                                    <img class="border-2 border-white rounded-full h-10 w-10 -mr-2" src="https://randomuser.me/api/portraits/women/32.jpg" alt="">
                                    <img class="border-2 border-white rounded-full h-10 w-10 -mr-2" src="https://randomuser.me/api/portraits/men/44.jpg" alt="">
                                    <img class="border-2 border-white rounded-full h-10 w-10 -mr-2" src="https://randomuser.me/api/portraits/women/42.jpg" alt="">
                                </div>
                                <span class="flex items-center justify-center text-sm text-grey-darker font-semibold border-2 border-grey-light rounded-full h-10 w-10">+3</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="relative" v-if="isMessage" style="overscroll-behavior: none;">
        <div
                class="fixed px-4 w-full bg-blue-800 h-16 pt-2 text-white flex justify-between shadow-md"
                style="top:0px; overscroll-behavior: none;"
        >

                <div class="text-green-100 font-bold text-sm tracking-wide ">Let's chat
                <div class="text-xs" v-if="isMessage">{{name}}</div>
                </div>
            <div class="text-white text-right block"  v-if="typing">{{typing.split('').includes(' ') ? typing.split(' ').slice(1).join() : typing}} is typing...</div>
            <!-- 3 dots -->
            <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    class="icon-dots-vertical w-8 h-8 mt-2 mr-2"
            >
                <path
                        class="text-green-100 fill-current"
                        fill-rule="evenodd"
                        d="M12 7a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 7a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 7a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"
                />
            </svg>
        </div>
        <div class="mt-20 mb-16">
            <div class="clearfix">
            <div class="clearfix">
                <div class="w-full flex flex-col" v-for="message in messages"
                        :class="message.type === 0 ? 'text-right bg-green-300 float-right w-3/4 mx-4 my-2 p-2 rounded-lg clearfix' : 'text-left bg-gray-300 w-3/4 mx-4 my-2 p-2 rounded-lg'"
                > <span class="flex items-center">{{message.message}} :  <small class="text-[10px] bg-blue-600 px-2 rounded-full text-white">{{message.by.split('').includes(' ') ? message.by.split(' ').slice(1).join() : message.by}}</small></span></div>
            </div>
        </div>
            <div :class="ready ? 'right-0 top-0' : 'right-0 bottom-10'" class="absolute right-0 top-0 transition-all ease-in-out delay-150" v-if="ready">
                <p v-for="item in info">{{item.name}} {{item.type}} joined</p>
            </div>
    </div>
    <div class="fixed w-full flex justify-between bg-blue-400" style="bottom: 0px;">
                  <textarea
                          v-model="newMessage"
                          class="flex-grow m-2 py-2 px-4 mr-1 rounded-full border border-gray-300 bg-gray-200 resize-none"
                          rows="1"
                          placeholder="Message..."
                          style="outline: none;"
                  ></textarea>
            <button @click="sendMessage" class="m-2" style="outline: none;">
                <svg
                        class="svg-inline--fa text-green-400 fa-paper-plane fa-w-16 w-12 h-12 py-2 mr-2"
                        aria-hidden="true"
                        focusable="false"
                        data-prefix="fas"
                        data-icon="paper-plane"
                        role="img"
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 512 512"
                >
                    <path
                            fill="currentColor"
                            d="M476 3.2L12.5 270.6c-18.1 10.4-15.8 35.6 2.2 43.2L121 358.4l287.3-253.2c5.5-4.9 13.3 2.6 8.6 8.3L176 407v80.5c0 23.6 28.5 32.9 42.5 15.8L282 426l124.6 52.2c14.2 6 30.4-2.9 33-18.2l72-432C515 7.8 493.3-6.8 476 3.2z"
                    />
                </svg>
            </button>
        </form>
    </div>
</div>
</div>
<script src="/socket.io/socket.io.js"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/axios@0.21.1/dist/axios.min.js"></script>
<script>
    const socket = io();
    const { createApp, ref, computed, onMounted, watch } = Vue

 const app = createApp({
        setup() {
            const newMessage = ref('')
            const messages = ref([])
            const typing = ref(false)
            const name = ref(null)
            const ready = ref(false)
            const info = ref([])
            const allUsers = ref([])
            const warning = ref(false)
            const profile = ref(false)
            const isMessage = ref(false)
            const showModal = ref(false)
            const profileImage = ref('https://randomuser.me/api/portraits/men/33.jpg')
            const sendMessage = ()=>{
                messages.value.push({message: newMessage.value , type: 0, by: 'Me'})
                socket.emit('chat-message',{message: newMessage.value , user: name.value, by: name.value})
                handleData({message: newMessage.value , user: name.value, by: name.value})
                newMessage.value = null

            }

            const handleData = (data)=>{
                let existingChat = JSON.parse(localStorage.getItem('socketData'))
                localStorage.setItem('socketData', JSON.stringify([...existingChat, data]));
            }

            const chatSwitch = ()=>{
                isMessage.value = true
                profile.value = false
                showModal.value = false
            }

            const login = ()=>{
                showModal.value = true
                isMessage.value = false
                profile.value = true
                allUsers.value.push({name: name.value})
                socket.emit('allUsers', {name: name.value})
                socket.emit('joined', name.value)
            }
            onMounted(()=>{
                console.log("info", info.value)
            })

            window.onbeforeunload=()=>{
                socket.emit('leaved',name.value)
            }
            watch(
                () => allUsers.value,
                (value) => {
                    value.length > 2 ? ready.value = false : ''
                    warning.value = true
                }
            )

            watch(
                () => newMessage.value,
                (value) => {
                    value ? socket.emit('typing', name.value) : socket.emit('stopTyping')
                }
            )

            socket.emit('Created','Saiem')
            socket.on('Created',(data)=>{
                console.log(data)
            })
            socket.on('chat-message',(data)=>{
                console.log("log",data)
                messages.value.push({message: data.message, type: 1 , by: data.by})
                typing.value = false
            })


            socket.on('typing',(name)=>{
                typing.value = name
            })
            socket.on('stopTyping',()=>{
                typing.value = false
            })
            socket.on('joined',(data)=>{
                info.value.push({name: data, type: 'joined'})
                setTimeout(()=>{
                    info.value = []
                },5000)
            })
            socket.on('leaved',(data)=>{
                info.value.push({name: data, type: 'leaved'})
                setTimeout(()=>{
                    info.value = []
                },5000)
            })

            socket.on('allUsers',(data)=>{
                console.log("log",data)
                allUsers.value.push({name:data.name})
                console.log("after push", allUsers.value)
            })

            return {
                newMessage,
                sendMessage,
                messages,
                typing,
                name,
                ready,
                // addName,
                info,
                allUsers,
                login,
                warning,
                profile,
                chatSwitch,
                isMessage,
                showModal,
                profileImage
            }
        }
    })
    app.mount('#app')
</script>
</body>
<style>
    .modal-vue .overlay {
        position: fixed;
        z-index: 9998;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, .5);
    }

    .modal-vue .modal {
        position: relative;
        width: 500px;
        z-index: 9999;
        margin: 0 auto;
        padding: 20px 30px;
        background-color: #fff;
    }

</style>

</html>